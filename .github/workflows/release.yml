name: Release
on:
  push:
    tags:
      - "v*"

permissions: read-all

jobs:
  build-and-publish-images:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Login to AWS Public ECR
        uses: docker/login-action@v2
        with:
          registry: public.ecr.aws
          username: ${{ secrets.AWS_ACCESS_KEY_ID }}
          password: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: Extract tag name
        id: extract_tag_name
        run: echo ::set-output name=tag::${GITHUB_REF#refs/tags/}
      - name: Build and push gitvote-dbmigrator image
        run: |
          docker build \
            -f database/migrations/Dockerfile \
            -t public.ecr.aws/g6m3a0y9/gitvote-dbmigrator:${{steps.extract_tag_name.outputs.tag}} \
            -t public.ecr.aws/g6m3a0y9/gitvote-dbmigrator:latest \
          .
          docker push --all-tags public.ecr.aws/g6m3a0y9/gitvote-dbmigrator
      - name: Build and push gitvote image
        run: |
          docker build \
            -t public.ecr.aws/g6m3a0y9/gitvote:${{steps.extract_tag_name.outputs.tag}} \
            -t public.ecr.aws/g6m3a0y9/gitvote:latest \
          .
          docker push --all-tags public.ecr.aws/g6m3a0y9/gitvote
